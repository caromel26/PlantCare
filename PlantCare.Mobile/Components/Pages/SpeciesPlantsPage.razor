@page "/species/plants/{id:int}"

@using PlantCare.Mobile.Models
@using PlantCare.Mobile.Services
@using MudBlazor
@using static MudBlazor.Icons

@inject ApiConnectionService<Species> ApiService
@inject ApiConnectionService<Plant> PlantsService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="page-container">
    <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">Back</MudButton>
    <MudText Typo="Typo.h4" Class="my-4">Plants of @Species?.Name</MudText>

    @if (PlantList == null)
    {
        <MudProgressCircular Indeterminate="true" Class="loading-spinner" />
    }
    else if (PlantList.Count == 0)
    {
        <MudText>No plants found for this species.</MudText>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var plant in PlantList)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="card border-success shadow">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@plant.Name</MudText>
                            <MudText>Last Watering Date: @plant.LastWateringDate?.ToString("yyyy-MM-dd")</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    Species Species;
    List<Plant> PlantList;

    protected override async Task OnInitializedAsync()
    {
        Species = await ApiService.GetByIdAsync("Species", Id);
        PlantList = await PlantsService.GetAllAsync("Plants");
        PlantList = PlantList.Where(p => p.SpeciesId == Id && p.IsActive).ToList();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/species");
    }
}
